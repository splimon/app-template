# Trigger template sync in downstream repositories when changes are pushed to main.
# Downstream repos are read from .github/downstream-repos.json
#
# SETUP REQUIRED:
# 1. Create a GitHub PAT with 'repo' scope that has access to all downstream repos
# 2. Add it as a repository secret named 'DOWNSTREAM_REPO_TOKEN'

name: Notify Downstream Repos

on:
  push:
    branches:
      - main
    paths-ignore:
      - '.github/downstream-repos.json'  # Don't trigger on registration changes
  workflow_dispatch:

jobs:
  load-repos:
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.get-repos.outputs.repos }}
      has_repos: ${{ steps.get-repos.outputs.has_repos }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get downstream repos
        id: get-repos
        run: |
          REPOS=$(cat .github/downstream-repos.json)
          echo "repos=$REPOS" >> $GITHUB_OUTPUT
          if [ "$REPOS" = "[]" ]; then
            echo "has_repos=false" >> $GITHUB_OUTPUT
          else
            echo "has_repos=true" >> $GITHUB_OUTPUT
          fi

  notify-downstream:
    needs: load-repos
    if: needs.load-repos.outputs.has_repos == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo: ${{ fromJson(needs.load-repos.outputs.repos) }}
      fail-fast: false
    steps:
      - name: Trigger template sync in ${{ matrix.repo }}
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.DOWNSTREAM_REPO_TOKEN }}
          repository: ${{ matrix.repo }}
          event-type: template-sync
          client-payload: |
            {
              "template_repo": "${{ github.repository }}",
              "template_sha": "${{ github.sha }}",
              "template_ref": "${{ github.ref_name }}"
            }
